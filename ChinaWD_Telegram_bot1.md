# Техническое задание: Телеграм-бот для автомобильного импорта

## 1. Общее описание проекта

**Цель проекта:** Разработка телеграм-бота для компании, занимающейся импортом автомобилей, с функционалом расчета стоимости, консультаций и приема заявок.

**Целевая аудитория:** 
- Потенциальные клиенты, желающие приобрести автомобили за рубежом
- Менеджеры компании (доступ к заявкам и базовой статистике)
- Администраторы (полный доступ к управлению системой)

**Платформа:** Telegram Bot API

## 2. Функциональные требования

### 2.1 Калькулятор стоимости

**Описание:** Интерактивный калькулятор для расчета полной стоимости покупки и доставки автомобиля из Китая.

**Входные параметры:**
- **Тип плательщика:** Физическое лицо (по умолчанию) / Юридическое лицо
- Стоимость автомобиля в Китае (CNY - китайские юани)
- Объем двигателя (куб.см)
- Год выпуска
- Тип кузова (легковой/внедорожник) - для утилизационного сбора
- Тип топлива (бензин/дизель/гибрид/электро)
- Мощность двигателя (л.с.) - для расчета акциза

**Формула расчета:**
```
Итоговая стоимость = 
  Цена авто в Китае (CNY) + 
  Комиссия банка за перевод (переменная) +
  Таможенные платежи (по тарифам РФ) + 
  Расходы в Китае (переменная) + 
  Комиссия компании (переменная) + 
  Стоимость доставки автовозом (переменная)
```

**Расчетные компоненты:**
- **Стоимость автомобиля** - вводится пользователем в юанях
- **Комиссия банка за перевод** - настраиваемая переменная:
  - Может быть фиксированной суммой или процентом от суммы перевода
  - Учитывает расходы на валютный перевод в Китай
  - Конвертируется в рубли по курсу с учетом банковской наценки
- **Таможенные платежи** - рассчитываются автоматически по российским тарифам:
  
  **ДЛЯ ФИЗИЧЕСКИХ ЛИЦ (расчет по умолчанию):**
  - **Таможенная пошлина** - льготные ставки для физлиц:
    - ❗ **АКТУАЛЬНЫЕ ТАРИФЫ с 01.01.2024:** обязательно загружать из официальных источников:
      - **TKS.RU** (calc.tks.ru) - проверенный таможенный калькулятор
      - **ФТС России** - официальные тарифы
      - **ТН ВЭД ЕАЭС** - актуальная версия
    - Структура: процентная ставка + минимальная ставка в евро за куб.см
    - Категории по возрасту: до 3 лет, 3-5 лет, 5-7 лет, свыше 7 лет
    - Зависит от объема двигателя и типа автомобиля
  - **Утилизационный сбор** для физлиц:
    - ❗ **ВАЖНО:** Актуальные размеры уточнить в Постановлении Правительства РФ
    - Зависит от типа транспортного средства и объема двигателя
  - **Акциз** (для авто определенной мощности):
    - ❗ **ВАЖНО:** Актуальные ставки уточнить в НК РФ (статья 193)
  
  **ДЛЯ ЮРИДИЧЕСКИХ ЛИЦ (опциональный расчет):**
  - **Таможенная пошлина**: 
    - ❗ **ВАЖНО:** Ставки уточнить в актуальном ТН ВЭД ЕАЭС
    - Обычно выше, чем для физлиц
  - **НДС 20%** от таможенной стоимости (цена + пошлина)
  - **Утилизационный сбор** для юрлиц:
    - ❗ **ВАЖНО:** Актуальные размеры значительно выше чем для физлиц
  - **Акциз** (аналогично физлицам)
- **Расходы в Китае** - настраиваемая переменная (услуги в Китае, оформление)
- **Комиссия компании** - настраиваемый процент
- **Стоимость доставки автовозом** - настраиваемая переменная

**Результат:**
- Детализированный расчет по каждой позиции
- Общая сумма
- Возможность сохранить расчет
- Кнопка "Заказать консультацию"

**Техническая реализация:**
- Inline клавиатуры для выбора параметров
- Валидация введенных данных (цена в CNY, объем двигателя, год, мощность)
- Выбор типа плательщика с физлицом по умолчанию
- Автоматический расчет банковской комиссии (фиксированная или процентная)
- **Автоматический расчет таможенных платежей:**
  - Приоритетный расчет для физических лиц (льготные ставки)
  - Альтернативный расчет для юридических лиц
  - Выбор правильной формулы пошлины в зависимости от типа плательщика
- Конвертация CNY в RUB и EUR в RUB по банковским курсам
- Сохранение расчетов в базе данных с привязкой к пользователю
- Детализированный отчет по каждой позиции расходов
- Экспорт расчета в PDF с логотипом компании (опционально)
- Возможность сравнения нескольких расчетов

### 2.2 FAQ-раздел

**Структура разделов:**
1. **Сроки доставки из Китая**
   - Время доставки автовозом (15-25 дней)
   - Сезонные особенности
   - Факторы, влияющие на сроки
   - Таможенное оформление в РФ

2. **Необходимые документы**
   - Для физических лиц (паспорт, ИНН)
   - Для юридических лиц (документы организации)
   - Документы на автомобиль из Китая
   - Документы для таможни РФ

3. **Процедура оформления**
   - Поиск и выбор автомобиля в Китае
   - Оплата и оформление покупки
   - Доставка до границы РФ
   - Таможенное оформление
   - Получение ПТС и регистрация

4. **Расчеты и платежи**
   - Цены в китайских юанях (CNY)
   - Официальный и банковский курс CNY/RUB
   - Банковские комиссии за валютные переводы
   - Способы оплаты (карты, переводы, криптовалюты)
   - Таможенные платежи в рублях

5. **Особенности китайского рынка**
   - Популярные бренды и модели
   - Электромобили и гибриды
   - Гарантия на китайские авто
   - Сервисное обслуживание в РФ

**Техническая реализация:**
- Иерархическое меню с inline клавиатурами
- Поиск по FAQ
- Возможность редактирования контента через команды администратора
- Статистика просмотров разделов

### 2.3 Система заявок

**Типы заявок:**
1. **Консультация** - общие вопросы
2. **Расчет под конкретный автомобиль**
3. **Заказ услуги** - готов начать процедуру
4. **Обратный звонок**

**Форма заявки включает:**
- Тип заявки (выбор из списка)
- Имя клиента
- Номер телефона
- Комментарий/описание запроса

**Обработка заявки:**
- Автоматическое уведомление клиента о получении
- Присвоение уникального номера
- Уведомление менеджеров в Telegram
- Статусы: Новая → В работе → Выполнена → Архив

### 2.4 Административный интерфейс в Telegram

**Система ролей:**
- Администраторы (полный доступ)
- Менеджеры (доступ к заявкам и базовой статистике)
- Обычные пользователи

**Функционал для администраторов:**

1. **📊 Статистика**
   - Просмотр количества пользователей
   - Статистика заявок за период
   - Активность пользователей
   - Популярные разделы FAQ
   
   Команды:
   ```
   /stats_users - статистика пользователей
   /stats_requests [период] - статистика заявок
   /stats_activity - статистика активности
   /stats_export - выгрузка статистики в CSV
   ```

2. **💰 Управление калькулятором**
   
   **Настройка переменных через команды:**
   ```
   /set_rate CNY [курс] - установка курса юаня
   /set_rate EUR [курс] - установка курса евро
   /set_commission [процент] - комиссия компании
   /set_bank_fee [сумма/процент] - банковская комиссия
   /set_delivery [сумма] - стоимость доставки
   /set_china_expenses [сумма] - расходы в Китае
   ```
   
   **Управление тарифами:**
   ```
   /update_duties - обновление таможенных тарифов
   /update_recycling - обновление утилизационного сбора
   /update_excise - обновление акцизных ставок
   ```

   **Альтернативный вариант через Google Sheets:**
   - Синхронизация с таблицей для удобного редактирования тарифов
   - Автоматическое обновление данных
   - Команды для управления синхронизацией:
     ```
     /sync_sheet - ручная синхронизация
     /sheet_status - статус подключения
     ```

3. **📝 Управление FAQ**
   
   Команды для работы с разделами:
   ```
   /faq_list - список разделов
   /faq_show [раздел] - просмотр раздела
   /faq_add [раздел] [текст] - добавление раздела
   /faq_edit [раздел] [текст] - редактирование
   /faq_delete [раздел] - удаление раздела
   ```
   
   Альтернативный вариант:
   - Загрузка JSON-файла с обновленной структурой FAQ
   - Команда для применения изменений:
     ```
     /faq_update [файл] - обновление через JSON
     ```

4. **📋 Управление заявками**
   
   Команды для менеджеров:
   ```
   /requests_new - показать новые заявки
   /requests_active - заявки в работе
   /request_info [номер] - информация по заявке
   /request_status [номер] [статус] - изменить статус
   /request_comment [номер] [текст] - добавить комментарий
   /requests_export - выгрузка заявок в CSV
   ```

5. **📢 Рассылки**
   
   Управление рассылками:
   ```
   /broadcast [текст] - мгновенная рассылка
   /broadcast_preview [текст] - предпросмотр
   /broadcast_schedule [дата] [текст] - отложенная
   /broadcast_cancel [id] - отмена отложенной
   ```

6. **👥 Управление пользователями**
   
   Команды:
   ```
   /ban [user_id] - заблокировать пользователя
   /unban [user_id] - разблокировать
   /user_info [user_id] - информация о пользователе
   /user_list - список пользователей
   ```

7. **🔐 Управление правами**
   ```
   /admin_add [id] - добавить администратора
   /admin_remove [id] - удалить администратора
   /manager_add [id] - добавить менеджера
   /manager_remove [id] - удалить менеджера
   ```

**Безопасность:**
- Проверка ID администраторов и менеджеров
- Подтверждение критических операций
- Логирование административных действий

## 3. Технические требования

### 3.1 Архитектура

**Backend:**
- Язык: Python 3.9+
- Framework: aiogram 3.x
- База данных: Replit Database
- Кеширование: Redis (опционально)

**Интеграции:**
- Google Sheets API (для управления тарифами)
- Telegram Bot API
- API курсов валют

**Хранение данных:**
- Настройки калькулятора
- База пользователей
- История заявок
- Структура FAQ
- Логи операций

### 3.2 Развертывание

**Платформа:** Replit
- Автоматический запуск бота
- Периодическое обновление данных
- Backup важных данных
- Мониторинг работоспособности

### 3.3 Масштабируемость

- Возможность добавления новых команд
- Расширение функционала калькулятора
- Добавление новых типов заявок
- Интеграция с CRM (опционально)

## 4. UX/UI требования

### 4.1 Телеграм-бот

**Принципы интерфейса:**
- Простая навигация (не более 3 уровней меню)
- Быстрые ответы (inline клавиатуры)
- Прогресс-бары для многошаговых процессов
- Возможность вернуться в главное меню в любой момент
- Эмодзи для улучшения восприятия

**Главное меню:**
```
🧮 Калькулятор для физлиц (из Китая)
❓ Частые вопросы (FAQ)
📝 Оставить заявку
🇨🇳 Популярные модели из Китая
⚖️ Расчет для юрлиц
📞 Контакты
ℹ️ О компании
```

### 4.2 Админ-панель

- Современный, интуитивно понятный интерфейс
- Темная/светлая тема
- Адаптивность для мобильных устройств
- Быстрый поиск по всем разделам
- Горячие клавиши для частых действий

## 5. Этапы разработки

### Этап 1 (2 недели)
- Настройка инфраструктуры
- Базовая структура бота
- Система пользователей
- Простое меню

### Этап 2 (3 недели)
- **Интеграция с источниками тарифов:**
  - Подключение к TKS.RU API или парсинг
  - Загрузка актуальных таможенных тарифов с 01.01.2024
  - Валидация данных из официальных источников
- Калькулятор стоимости с корректными тарифами
- База данных расчетов
- Базовая админ-панель

### Этап 3 (2 недели)
- FAQ-система
- Система заявок
- Email-уведомления

### Этап 4 (2 недели)
- Полнофункциональная админ-панель
- Система рассылок
- Статистика и аналитика

### Этап 5 (1 неделя)
- Тестирование
- Оптимизация
- Развертывание

## 6. Критерии приемки

- [ ] Все функции работают согласно ТЗ
- [ ] Админ-панель позволяет управлять всем контентом
- [ ] **Калькулятор использует актуальные таможенные тарифы:**
  - [ ] Тарифы загружены из официальных источников (TKS.RU, ФТС)
  - [ ] Расчеты проверены на тестовых данных с известными результатами
  - [ ] Формулы соответствуют действующему законодательству РФ
- [ ] Заявки корректно сохраняются и обрабатываются
- [ ] Бот выдерживает нагрузку 100+ одновременных пользователей
- [ ] Время ответа бота не превышает 2 секунд
- [ ] Покрытие тестами не менее 80%
- [ ] Документация по API и развертыванию

## 7. Сопровождение

**Гарантийное обслуживание:** 3 месяца
**Техническая поддержка:** исправление багов, мелкие доработки
**Обновления:** новые функции по отдельному соглашению

## 8. Стоимость и сроки

**Срок разработки:** 10 недель
**Команда:** 1 backend-разработчик, 1 frontend-разработчик
**Дополнительно:** дизайнер (по необходимости), DevOps-инженер (настройка инфраструктуры)

---

## ⚠️ КРИТИЧЕСКИ ВАЖНО

**Таможенные тарифы и расчеты** - это основная функция бота. Все тарифы ОБЯЗАТЕЛЬНО должны быть загружены из официальных источников и регулярно обновляться. Неактуальные тарифы могут привести к серьезным финансовым последствиям для клиентов.

**Рекомендуемые источники актуальных тарифов:**
- [TKS.RU](https://www.tks.ru/auto/calc/) - проверенный таможенный калькулятор
- ФТС России - официальные документы
- ТН ВЭД ЕАЭС - актуальная версия

*Данное техническое задание может быть дополнено и уточнено в процессе обсуждения с заказчиком.* 

## 3. Версия бота 2.0: Будущие улучшения

В этом разделе собраны идеи и задачи для следующей крупной итерации разработки бота.

### 3.1 Улучшение системы заявок

-   **Централизованное хранилище заявок:**
    -   **Проблема:** Заявки "живут" только в личных сообщениях у администраторов. Если администратор удалит чат с ботом, история заявок потеряется.
    -   **Решение:** Создать единую базу данных (например, JSON-файл на первом этапе, а в будущем — полноценную БД) для хранения всех заявок. Это обеспечит сохранность данных, возможность их анализа и совместной работы.
    -   **Затрагивает разделы:** `Система заявок`, `Административный интерфейс`.

-   **Внедрение статусов заявок:**
    -   **Проблема:** Нельзя понять, взял ли кто-то заявку в работу или она еще не обработана.
    -   **Решение:** Добавить для каждой заявки статусы (`Новая`, `В работе`, `Выполнена`, `Архив`) и предоставить менеджерам интерфейс для их изменения. Это позволит отслеживать жизненный цикл каждой заявки.
    -   **Затрагивает разделы:** `Система заявок`, `Административный интерфейс`.

-   **Единый интерфейс для работы с заявками:**
    -   **Проблема:** Менеджерам приходится работать с заявками в разрозненных личных сообщениях, что неудобно для команды.
    -   **Решение:** Создать в админ-панели специальный раздел, где менеджеры могут просматривать список всех заявок, фильтровать их по статусу и брать в работу. Уведомления о новых заявках могут приходить в единый рабочий чат.
    -   **Затрагивает разделы:** `Система заявок`, `Административный интерфейс`.

-   **Типизация заявок:**
    -   **Проблема:** Все заявки приходят в универсальном формате, что не позволяет менеджеру сразу понять суть запроса клиента.
    -   **Решение:** Внедрить в начале диалога выбор типа заявки (например: "Общая консультация", "Расчет под конкретный авто", "Заказ услуги", "Запросить обратный звонок"). Это позволит сразу классифицировать обращение и направить его к нужному специалисту или подготовиться к разговору.
    -   **Затрагивает разделы:** `Система заявок`, `Пользовательский интерфейс`. 